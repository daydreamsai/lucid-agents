# PRD: ERC-8004 Service Expansion and OASF Auto-Generation

Status: Final
Owner: SDK (Identity + Core + Adapters + CLI)
Last Updated: 2026-02-10

## Summary

Expand the identity registration flow so agents can publish richer ERC-8004 `services[]` metadata and automatically generate OASF metadata the same way A2A metadata is generated today.

This PRD locks three decisions:

1. OASF metadata is auto-generated by default when enabled.
2. Invalid OASF configuration is a startup blocker.
3. Structured OASF config is provided as JSON arrays and is strictly validated.

## Problem

Current identity registration support is incomplete for service discovery. Users need first-class support for:

- `OASF`
- `twitter`
- `web`
- `email`

They also need a consistent way to generate OASF metadata instead of manually hosting it and manually wiring endpoints.

## Goals

- Emit ERC-8004-compliant `services[]` entries for `OASF`, `twitter`, `web`, and `email`.
- Auto-generate an OASF record and expose it over a well-known endpoint.
- Validate OASF inputs strictly at startup and fail fast on invalid config.
- Use JSON-array config for structured OASF fields.
- Keep behavior consistent across Hono, Express, and TanStack adapters.

## Non-Goals

- Implementing remote OASF publishing to IPFS or third-party registries.
- Building a UI for OASF editing.
- Relaxed runtime fallback behavior for invalid OASF config.

## User Stories

- As an agent developer, I can enable OASF and have the SDK generate and serve the record automatically.
- As an agent developer, I can set Twitter, website, and email once and have them appear in ERC-8004 `services[]`.
- Operators receive a hard startup failure when the OASF config is malformed.

## Functional Requirements

### FR-1: ERC-8004 `services[]` expansion

When identity registration is generated, `services[]` must support:

- `A2A`
- `web`
- `OASF`
- `twitter`
- `email`

Behavior:

- Service entries are emitted only when selected/enabled.
- `OASF` entry includes `endpoint`, `version`, and optional `skills` and `domains`.
- `twitter` and `email` are represented as service entries with `endpoint`.
- Existing service behavior remains backward compatible.

### FR-2: OASF auto-generation and serving

When OASF auto-generation is enabled:

- SDK generates an OASF record from runtime metadata and entrypoints.
- Adapters expose the generated record at:
  - `/.well-known/oasf-record.json`
- ERC-8004 `services[]` `OASF.endpoint` must point to that URL by default unless explicitly overridden.

### FR-3: Strict startup validation

Startup must fail (throw) before serving requests when:

- Required OASF config is missing while OASF is enabled.
- JSON array values are invalid JSON.
- Parsed JSON is not an array.
- Array members violate schema (wrong type, empty strings, invalid URL where URL is required).
- Conflicting options are provided.

No soft warnings for malformed OASF config. This is strict-fail.

### FR-4: JSON-array configuration contract

Structured OASF fields are supplied as JSON-array strings (env/config).

Required contract (string values that parse to arrays):

- `IDENTITY_OASF_AUTHORS_JSON`
- `IDENTITY_OASF_SKILLS_JSON`
- `IDENTITY_OASF_DOMAINS_JSON`
- `IDENTITY_OASF_MODULES_JSON`
- `IDENTITY_OASF_LOCATORS_JSON`

Rules:

- Empty array (`[]`) is valid.
- Invalid JSON or non-array payload fails startup.
- Element validation is strict by field schema.

### FR-5: Registration defaults and selection model

The registration API must support explicit service selection and defaults:

- Selection flags for `A2A`, `web`, `OASF`, `twitter`, `email`.
- Default OASF version from SDK config.
- Default endpoints derived from runtime origin where applicable.

## API and Type Requirements

- Identity options expose a single typed registration config for service selection and OASF metadata.
- OASF config has a single source of truth type.
- Generated registration output uses canonical `services[]` entries.
- Legacy compatibility fields can be read, but canonical fields are emitted.

## Adapter Requirements

All supported adapters must:

- Serve `/.well-known/oasf-record.json` when OASF auto-generation is enabled.
- Return consistent content type and status.
- Fail startup consistently when strict validation fails.

## CLI and Template Requirements

- Identity template prompts include OASF enablement and OASF structured fields.
- Structured prompts are documented as JSON arrays.
- Generated `.env` uses the JSON-array contract keys.
- Non-interactive mode must support these keys directly.

## Observability and Errors

Startup failures must include:

- Exact invalid key.
- Expected format.
- Example valid value.

Error output must be deterministic and actionable.

## Testing Requirements

### Unit

- Registration service emission for each supported service.
- OASF JSON-array parser validation (valid and invalid cases).
- Strict-fail behavior for all validation errors.
- Default endpoint/version behavior.

### Integration

- Adapter endpoint test for `/.well-known/oasf-record.json`.
- ERC-8004 manifest/registration includes correct `OASF` service endpoint.
- End-to-end startup failure test for malformed OASF config.

### CLI

- Wizard and non-interactive generation for OASF JSON-array env values.
- Template output includes new OASF keys.

## Acceptance Criteria

- Agents can configure and emit `OASF`, `twitter`, `web`, `email` in ERC-8004 `services[]`.
- OASF record is auto-generated and served via `/.well-known/oasf-record.json`.
- Invalid OASF config blocks startup in all adapters.
- JSON-array config is required and strictly validated for structured OASF fields.
- Tests cover unit, integration, and CLI paths for the above behavior.

## Rollout and Migration

- Backward compatible for existing agents that do not enable OASF.
- New OASF behavior is opt-in by selection flag.
- Existing registration consumers continue to parse legacy-compatible fields.
