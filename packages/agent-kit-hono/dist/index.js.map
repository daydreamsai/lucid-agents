{"version":3,"sources":["../src/utils.ts","../src/paywall.ts","../src/app.ts"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import { z } from \"zod\";\n\nexport function toJsonSchemaOrUndefined(s?: z.ZodTypeAny) {\n  if (!s) return undefined;\n  try {\n    return z.toJSONSchema(s);\n  } catch {\n    return undefined;\n  }\n}\n","import type { Hono } from \"hono\";\nimport { paymentMiddleware } from \"x402-hono\";\nimport type { FacilitatorConfig } from \"x402/types\";\nimport type { EntrypointDef, PaymentsConfig } from \"@lucid-agents/agent-kit\";\nimport { resolveEntrypointPrice } from \"@lucid-agents/agent-kit\";\nimport { toJsonSchemaOrUndefined } from \"./utils\";\n\ntype PaymentMiddlewareFactory = typeof paymentMiddleware;\n\nexport type WithPaymentsParams = {\n  app: Hono;\n  path: string;\n  entrypoint: EntrypointDef;\n  kind: \"invoke\" | \"stream\";\n  payments?: PaymentsConfig;\n  facilitator?: FacilitatorConfig;\n  middlewareFactory?: PaymentMiddlewareFactory;\n};\n\nexport function withPayments({\n  app,\n  path,\n  entrypoint,\n  kind,\n  payments,\n  facilitator,\n  middlewareFactory = paymentMiddleware,\n}: WithPaymentsParams): boolean {\n  if (!payments) return false;\n  const network = entrypoint.network ?? payments.network;\n  if (!network) return false;\n  const price = resolveEntrypointPrice(entrypoint, payments, kind);\n  if (!price) return false;\n  if (!payments.payTo) return false;\n  const requestSchema = toJsonSchemaOrUndefined(entrypoint.input);\n  const responseSchema = toJsonSchemaOrUndefined(entrypoint.output);\n\n  const description =\n    entrypoint.description ??\n    `${entrypoint.key}${kind === \"stream\" ? \" (stream)\" : \"\"}`;\n  const postMimeType =\n    kind === \"stream\" ? \"text/event-stream\" : \"application/json\";\n  const inputSchema = {\n    bodyType: \"json\" as const,\n    ...(requestSchema ? { bodyFields: { input: requestSchema } } : {}),\n  };\n  const outputSchema =\n    kind === \"invoke\" && responseSchema\n      ? { output: responseSchema }\n      : undefined;\n\n  const resolvedFacilitator: FacilitatorConfig =\n    facilitator ??\n    ({ url: payments.facilitatorUrl } satisfies FacilitatorConfig);\n\n  const postRoute = {\n    price,\n    network,\n    config: {\n      description,\n      mimeType: postMimeType,\n      discoverable: true,\n      inputSchema,\n      outputSchema,\n    },\n  };\n\n  const getRoute = {\n    price,\n    network,\n    config: {\n      description,\n      mimeType: \"application/json\",\n      discoverable: true,\n      inputSchema,\n      outputSchema,\n    },\n  };\n\n  app.use(\n    path,\n    middlewareFactory(\n      payments.payTo as Parameters<PaymentMiddlewareFactory>[0],\n      {\n        [`POST ${path}`]: postRoute,\n        [`GET ${path}`]: getRoute,\n      },\n      resolvedFacilitator\n    )\n  );\n  return true;\n}\n","import { Hono } from \"hono\";\nimport type { AgentMeta, EntrypointDef } from \"@lucid-agents/agent-kit\";\nimport { withPayments } from \"./paywall\";\nimport {\n  createAgentHttpRuntime,\n  type CreateAgentHttpOptions,\n} from \"@lucid-agents/agent-kit\";\n\nexport type CreateAgentAppOptions = CreateAgentHttpOptions & {\n  /**\n   * Hook called before mounting agent routes.\n   * Use this to register custom middleware that should run before agent handlers.\n   */\n  beforeMount?: (app: Hono) => void;\n  /**\n   * Hook called after mounting all agent routes.\n   * Use this to register additional custom routes or error handlers.\n   */\n  afterMount?: (app: Hono) => void;\n};\n\nexport function createAgentApp(\n  meta: AgentMeta,\n  opts?: CreateAgentAppOptions\n) {\n  const runtime = createAgentHttpRuntime(meta, opts);\n  const app = new Hono();\n\n  // Allow custom middleware before agent routes\n  opts?.beforeMount?.(app);\n\n  const registerEntrypointRoutes = (entrypoint: EntrypointDef) => {\n    const invokePath = `/entrypoints/${entrypoint.key}/invoke` as const;\n    const streamPath = `/entrypoints/${entrypoint.key}/stream` as const;\n\n    withPayments({\n      app,\n      path: invokePath,\n      entrypoint,\n      kind: \"invoke\",\n      payments: runtime.payments,\n    });\n\n    app.post(invokePath, (c) =>\n      runtime.handlers.invoke(c.req.raw, { key: entrypoint.key })\n    );\n\n    if (entrypoint.stream) {\n      withPayments({\n        app,\n        path: streamPath,\n        entrypoint,\n        kind: \"stream\",\n        payments: runtime.payments,\n      });\n\n      app.post(streamPath, (c) =>\n        runtime.handlers.stream(c.req.raw, { key: entrypoint.key })\n      );\n    }\n  };\n\n  // Core routes\n  app.get(\"/health\", (c) => runtime.handlers.health(c.req.raw));\n  app.get(\"/entrypoints\", (c) =>\n    runtime.handlers.entrypoints(c.req.raw)\n  );\n  app.get(\"/.well-known/agent.json\", (c) =>\n    runtime.handlers.manifest(c.req.raw)\n  );\n  app.get(\"/.well-known/agent-card.json\", (c) =>\n    runtime.handlers.manifest(c.req.raw)\n  );\n\n  app.get(\"/favicon.svg\", (c) => runtime.handlers.favicon(c.req.raw));\n\n  if (runtime.handlers.landing && opts?.landingPage !== false) {\n    app.get(\"/\", (c) => runtime.handlers.landing!(c.req.raw));\n  } else {\n    app.get(\"/\", (c) => c.text(\"Landing disabled\", 404));\n  }\n\n  const addEntrypoint = (def: EntrypointDef) => {\n    runtime.addEntrypoint(def);\n    const entrypoint = runtime\n      .snapshotEntrypoints()\n      .find((item) => item.key === def.key);\n    if (!entrypoint) {\n      throw new Error(`Failed to register entrypoint \"${def.key}\"`);\n    }\n    registerEntrypointRoutes(entrypoint);\n  };\n\n  for (const entrypoint of runtime.snapshotEntrypoints()) {\n    registerEntrypointRoutes(entrypoint);\n  }\n\n  // Allow custom routes and handlers after agent routes\n  opts?.afterMount?.(app);\n\n  return {\n    app,\n    agent: runtime.agent,\n    addEntrypoint,\n    config: runtime.config,\n    get payments() {\n      return runtime.payments;\n    },\n  };\n}\n"]}